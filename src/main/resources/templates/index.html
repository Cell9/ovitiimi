<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Lukuvinkit</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <link href="../static/css/bootstrap.css" rel="stylesheet" th:href="@{/css/bootstrap.css}">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>

</head>

<body>
    <div th:replace="fragments/navbar"></div>
    <br>
    <div class="container" th:if="${message}">
        <div class="alert alert-success alert-dismissible fade show" role="alert" >
            <a th:text="${message}"></a>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    </div>
    <br>
    <div class="container">
        <h2>Lukuvinkkien filtteröinti</h2>
        <p>Lukuvinkkejä voi filtteröidä minka tahansa hakusanan perusteella,
            mutta myös lukuvinkin tyypin, tagien tai kurssien perusteella. AND-filtteröinti hakee lukuvinkit, jotka toteuttavat molemmat syötetyistä ehdoista, ja
            OR-filtteröinti ne lukuvinkit, jotka toteuttavat ainakin toisen ehdoista.</p>
        <div class="container">
            <div class="row">
                <div class="col-sm">
                    <span>
                        <input type="text" class="form-control" id="filterInput1"
                               onkeyup="filterTable()" placeholder="Hakusana"
                               title="Etsi listasta">
                        <select id="picker1" class="selectpicker" onChange="filterTable()">
                            <option value="table-class">Kaikki</option>
                            <option value="type-class">Tyyppi</option>
                            <option value="tags-class">Tagi</option>
                            <option value="courses-class">Kurssi</option>
                        </select>
                    </span>
                </div>

                <div class="col-sm" align="center">
                    <select id="andor" class="selectpicker" onChange="filterTable()">
                        <option value="and">AND</option>
                        <option value="or">OR</option>
                    </select>
                </div>
                <div class="col-sm">
                    <span>
                        <input type="text" class="form-control" id="filterInput2"
                               onkeyup="filterTable()" placeholder="Hakusana"
                               title="Etsi listasta">
                        <select id="picker2" class="selectpicker" onChange="filterTable()">
                            <option value="table-class">Kaikki</option>
                            <option value="type-class">Tyyppi</option>
                            <option value="tags-class">Tagi</option>
                            <option value="courses-class">Kurssi</option>
                        </select>
                    </span>
                </div>
            </div>
        </div>
    </div>
    <br>
    <div class="container" id="vinkkilista" th:if="${recommendations}">
        <h2>Lukuvinkit</h2>
        <table class="table">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">Kuvaus</th>
                    <th scope="col">Kurssit</th>
                    <th scope="col">Tagit</th>
                    <th scope="col">Tyyppi</th>
                    <th scope="col">Luettu</th>
                </tr>
            </thead>
            <tbody>
                <div th:each="recommendation : ${recommendations}">
                    <tr>
                        <td><a th:href="@{/lukuvinkki/(id=${recommendation.id})}" class="table-class"
                                th:text="${recommendation}" /></td>
                        <td>
                            <p class="table-class courses-class" th:text="${recommendation.coursesAsString()}" />
                        </td>
                        <td>
                            <p class="table-class tags-class" th:text="${recommendation.tagsAsString()}" />
                        </td>
                        <td>
                            <p class="table-class type-class" th:text="${recommendation.type}" />
                        </td>
                        <td><span th:title="${recommendation.readTime}" th:id="${recommendation.id}" class="btn-read fa"
                                th:classappend="${recommendation.readTime == null} ? fa-square : fa-check-square"></span>
                        </td>
                    </tr>
                </div>
                <tr>
                </tr>
            </tbody>
        </table>
    </div>
</body>
<script>

    function filterTable() {
        let filter1 = document.getElementById("filterInput1").value.toUpperCase();
        let filter2 = document.getElementById("filterInput2").value.toUpperCase();
        let rajaus1 = document.getElementById("picker1").value;
        let rajaus2 = document.getElementById("picker2").value;
        let andor = document.getElementById("andor").value;
        switch (andor) {
            case "or":
                orFilter(filter1, filter2, rajaus1, rajaus2);
                break;
            case "and":
                andFilter(filter1, filter2, rajaus1, rajaus2);
                break;
            default:
        }
    }

    function orFilter(filter1, filter2, rajaus1, rajaus2) {
        let table = document.getElementById("vinkkilista");
        let rows = table.getElementsByTagName("tr");
        for (i = 1; i < rows.length; i++) {
            tr = rows[i];
            filter1Pass = rowFilter(tr, filter1, rajaus1);
            filter2Pass = rowFilter(tr, filter2, rajaus2);
            if (filter1Pass || filter2Pass) {
                tr.style.display = "";
            } else {
                tr.style.display = "none";
            }
        }
    }

    function andFilter(filter1, filter2, rajaus1, rajaus2) {
        table = document.getElementById("vinkkilista");
        rows = table.getElementsByTagName("tr");
        for (i = 1; i < rows.length; i++) {
            tr = rows[i];
            filter1Pass = rowFilter(tr, filter1, rajaus1);
            filter2Pass = rowFilter(tr, filter2, rajaus2);
            if (filter1Pass && filter2Pass) {
                tr.style.display = "";
            } else {
                tr.style.display = "none";
            }
        }
    }

    function rowFilter(row, filter, rajaus) {
        let tds = row.getElementsByClassName(rajaus);
        for (j = 0; j < tds.length; j++) {
            let td = tds[j];
            let txtValue = td.textContent || td.innerText;
            txtValue = txtValue.toUpperCase();
            if (txtValue.includes(filter)) {
                return true;
            }
        }
        return false;
    }

    $(".btn-read").click(function () {
        var clicked = $(this);

        var read = clicked.hasClass("fa-check-square");

        setReadStatus(clicked, !read);

        fetch("recommendation/read",
            {
                method: "POST",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(
                    {
                        id: clicked.attr('id'),
                        read: !read
                    })
            }).then((response) => response.json())
            .then((json) => {
                if (!json.success) {
                    setReadStatus(clicked, read);

                    alert(json.error);
                }
                else {
                    setReadStatus(clicked, !read);
                }
            })
            .catch((error) => setReadStatus(clicked, read));
    });

    function setReadStatus(target, read) {
        if (read) {
            target.removeClass("fa-square");
            target.addClass("fa-check-square");
        }
        else {
            target.removeClass("fa-check-square");
            target.addClass("fa-square");
        }
    }

</script>

<style>
    .btn-read {
        cursor: pointer;
    }

    .green {
        color: green;
    }
</style>

</html>